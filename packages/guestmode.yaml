input_boolean:
  guestmode_by_guest_network:
    name: "Guest mode enabled by guest network"
    icon: mdi:wifi-alert

automation:
  - id: guestmode_auto_disable_when_no_guests
    alias: "Auto disable guest mode when no guests on network"
    mode: single
    trigger:
      - platform: numeric_state
        entity_id: sensor.guest_network_count
        below: 1
        for:
          minutes: 5
    condition:
      - condition: state
        entity_id: input_boolean.guestmode
        state: "on"
      - condition: state
        entity_id: input_boolean.guestmode_by_guest_network
        state: "on"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.guestmode
            - input_boolean.guestmode_by_guest_network
      - service: script.telegram_notify
        data:
          message: "Gjestemodus automatisk deaktivert fordi ingen enheter er på gjestenettet lenger."

  - alias: guestmode_turnOffLightsAndHeating
    trigger:
      - platform: time
        at: "23:59:00"
    condition:
      - condition: state
        entity_id: input_boolean.guestmode
        state: "on"
    action:
      - service: lock.lock
        data:
          entity_id: lock.ytterdor_bluetooth
          code: !secret lock_code

      - entity_id: script.alllightsoff
        service: script.turn_on
      - entity_id: script.alllightsoff
        service: script.turn_on
      - service: switch.turn_off
        entity_id: switch.nexa3 #Fan Heater

  - id: guestmode_lockdoors
    alias: guestmode_lockdoors
    trigger:
      - platform: state
        entity_id: binary_sensor.hoveddor
        to: "off"
        for:
          minutes: 30
    condition:
      - condition: state
        entity_id: input_boolean.guestmode
        state: "on"
    action:
      - service: lock.lock
        data:
          entity_id: lock.ytterdor_bluetooth
          code: !secret lock_code

  - alias: Guestmode Notify Movement
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.motion_bedroom
          - binary_sensor.motion_downstairs_office
          - cover.garage_door
        to: "on"
        from: "off"
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.erlendhome
          state: "off"
        - condition: state
          entity_id: input_boolean.guestmode
          state: "on"
    action:
      - service: script.telegram_notify
        data_template:
          message: "Motion detected in {{ trigger.from_state.name }}."

  - id: guestmode_auto_disable
    alias: "Auto Disable Guestmode"
    mode: single
    trigger:
      - platform: state
        entity_id: sensor.alarm
        to: "Disarm"
        from:
          - "Arm Home"
          - "Arm Away"
          - "Arm Night"
        for:
          minutes: 10
    condition:
      - condition: state
        entity_id: input_boolean.guestmode
        state: "on"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.guestmode
            - input_boolean.guestmode_by_guest_network
      - service: script.telegram_notify
        data:
          message: "Gjestemodus automatisk slått av fordi du er hjemme og våken."
      - service: script.turn_on
        entity_id: script.notifycaroline
        data:
          variables:
            message: "Gjestemodus automatisk slått av fordi noen er hjemme og våken."
      - service: script.turn_on
        entity_id: script.ai_say
        data:
          prompt: "Gjestemodus er nå slått av."

template:
  - binary_sensor:
      - name: "guestmode_activated"
        unique_id: guestmode_activated_sensor
        state: >
          {{ states.input_boolean.guestmode.state == 'on' and states.sensor.alarm.state != 'Disarm' }}
