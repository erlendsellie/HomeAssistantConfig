# VVB (Hot Water Tank) Sensors
# Beregner antall kWh det tar å varme bereder til settpunkt temperatur-
# t1 = settpunkt temperatur
# t2 = temperatur bereder
# l = tankstørrelse (200L)
# 4.186 = 4186 er konstanten for varmekapasiteten til vann
# 3600 = sekunder i en time

template:
  - sensor:
      - name: "vvb_kwh_diff_til_max"
        unique_id: vvb_kwh_diff_til_max_sensor
        icon: "mdi:lightning-bolt-outline"
        unit_of_measurement: "kWh"
        state: >-
          {% set t1 = 70 | float %}
          {% set l = 200 %}
          {% set k = 4.186 %}
          {% set kt = 3600 %}
          {% set t2 = states('sensor.vvb_average') | float(default=0) %}
          {{ (k * l * (t1 - t2) /kt) | round(2) }}

      - name: "energi_i_vvb"
        unique_id: energi_i_vvb_sensor
        icon: "mdi:lightning-bolt-outline"
        unit_of_measurement: "kWh"
        state: >-
          {% set l = 200 %}
          {% set k = 4.186 %}
          {% set kt = 3600 %}
          {% set kx = 40 %}
          {% set t2 = states('sensor.vvb_average') | float(default=0) %}
          {{ (k * l * (t2 - kx) /kt) | round(2) }}

      - name: "energi_i_vvb_max"
        unique_id: energi_i_vvb_max_sensor
        icon: "mdi:lightning-bolt-outline"
        unit_of_measurement: "kWh"
        state: >-
          {% set tx = 70 | float %}
          {% set l = 200 %}
          {% set k = 4.186 %}
          {% set kt = 3600 %}
          {% set kx = 40 %}
          {{ (k * l * (tx - kx) /kt) | round(2) }}

      - name: "vvb_tid_til_70"
        unique_id: vvb_tid_til_70_sensor
        icon: "mdi:lightning-bolt-outline"
        state: >-
          {% set p = 2 %}
          {% set kwh = states('sensor.vvb_kwh_diff_til_max') | float(default=0) %}
          {{ ((kwh / p) | round(2)) | float }}

      - name: "vvb_kostnad_70"
        unique_id: vvb_kostnad_70_sensor
        icon: "mdi:lightning-bolt-outline"
        unit_of_measurement: "kr"
        state: >-
          {% set kwh = states('sensor.vvb_kwh_diff_til_max') | float(default=0) %}
          {% set kr = states('sensor.priceanalyzer_price') | float(default=0) %}
          {{ (kwh * kr) | round(2) }}

      - name: "vvb_desimaltid_til_klokketid"
        unique_id: vvb_desimaltid_til_klokketid_sensor
        icon: "mdi:store-24-hour"
        state: >
          {% set m = states('sensor.vvb_tid_til_70') | float(default=0) %}
          {{ '%02i:%02i'%(m/60,(60*m)%60) }}

      - name: "fyllingsgrad_vvb"
        unique_id: fyllingsgrad_vvb_sensor
        icon: "mdi:lightning-bolt-outline"
        unit_of_measurement: "%"
        state: >-
          {% set kwha = states('sensor.energi_i_vvb') | float(default=0) %}       
          {% set kwhs = states('sensor.energi_i_vvb_max') | float(default=0) %}
          {% set l = 200 %}
          {% set k = 4.186 %}
          {% set kt = 3600 %}
          {% set kx = 40 %}
          {{ 100-(((kwhs-kwha)*100))*10/100 | round(2) }}
