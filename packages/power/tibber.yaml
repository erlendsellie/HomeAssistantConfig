tibber:
  template:
    - binary_sensor:
        # Sensor som trigger automasjon om Tibber fryser.
        # Denne sensoren blir true, når det er over 2 minutter siden Pulse-sensoren har oppdatert seg, ca.
        # OBS! Har du solceller på taket, kan Tibber Pulse-sensoren din være 0, uten at sensoren er fryst.
        # bruk da en annen sensor, for eksempel 'kostnad i dag' eller 'gjennomsnitt i dag', som rapporterer data ofte fra Tibber.
        - name: "Tibber Unavailable"
          delay_on:
            minutes: 2
          state: >-
            {{
              as_timestamp(now())
              - 
              as_timestamp(states.sensor.power_sivert_thonstads_vei_6b.last_changed)
              | float
              > 10
            }}

  #TODO Fiks varsling for å varsle riktig når sensor blir tilgjengelig igjen,
  # om den feiler ved første relasting.
  automation:
    - id: reloadTibber
      alias: reloadTibber
      trigger:
        - platform: state
          entity_id: binary_sensor.tibber_unavailable
          to: "on"
      action:
        - repeat:
            while:
              - condition: state
                entity_id: binary_sensor.tibber_unavailable
                state: "on"
            sequence:
              - service: homeassistant.reload_config_entry
                entity_id: sensor.power_sivert_thonstads_vei_6b
              - delay:
                  seconds: 10
              # Varsling med sensor-verdi, 10 sekunder etter relasting av integrasjonen.
              - condition: state
                entity_id: binary_sensor.tibber_unavailable
                state: "on"
              - service: script.turn_on
                entity_id: script.notify
                data_template:
                  variables:
                    title: Tibber var utilgjengelig
                    message: >-
                      Tibber er fortsatt utilgjengelig, prøver på nytt om 2 minutter.
                      Sist endret for {{relative_time(states.sensor.power_sivert_thonstads_vei_6b.last_changed)}} siden
              - delay:
                  minutes: 2
        - condition: state
          entity_id: binary_sensor.tibber_unavailable
          state: "off"
        - service: script.turn_on
          entity_id: script.notify
          data_template:
            variables:
              title: Tibber var utilgjengelig
              message: >-
                Er tilgjengelig nå
                Sist endret for {{relative_time(states.sensor.power_sivert_thonstads_vei_6b.last_changed)}} siden

#  tibber_custom:
